## 技术调研：Go 语言 MySQL 通用底层框架可复用开源组件（v1.0）

- 文档状态：草案（可作为基线）
- 修订日期：2025-08-14
- 调研目标：从 GitHub 等公开资料收集可复用的 Go 生态组件，支撑以下能力，避免重复造轮子：
  - MySQL 驱动与连接池
  - 基于连接池自动管理的连接对象
  - 高效查询方法（预编译缓存、批量/流式、扫描与绑定、错误分类与幂等重试）
  - 观测与治理（日志、指标、Tracing、慢查询）
  - 测试工具（内存型 MySQL/模拟器、临时数据库、数据夹具/迁移、SQL mock）

### 1. 结论概览（推荐组合）
- 核心依赖：
  - 驱动：go-sql-driver/mysql（成熟、性能好、MPL 2.0）
  - SQL 扩展：sqlx 或 scany（极简、与 database/sql 兼容）
  - 观测：XSAM/otelsql（为 database/sql 提供 OTel Trace/Metric）
- 测试与“内存型 MySQL”：
  - 轻量单测：go-sqlmock（精确断言 SQL 与结果）
  - 集成/端到端：testcontainers-go + mysql 官方镜像（可复现实库行为）
  - 内存/嵌入式 MySQL 协议实现（可选）：dolthub/go-mysql-server（Go 实现的 MySQL 服务器/引擎，可用内存存储，适合快速集成测试和定制场景；与真实 MySQL 仍存在差异）
- 迁移与夹具：golang-migrate 或 goose（脚本迁移），配合自研 Fixture Loader
- 查询构建/批量：
  - 直接使用原生 SQL + sqlx 命名参数/批量
  - 若需要 Query Builder：goqu 或 squirrel（可选）
- 重试与错误分类：cenkalti/backoff 或自研轻量封装（结合 MySQL 错误码分类）

推荐最小落地组合：mysql driver + sqlx + otelsql + (testcontainers-go | sqlmock) + migrate/goose。

### 2. 候选组件清单与评估

2.1 驱动与连接池
- go-sql-driver/mysql（MPL-2.0）
  - 仓库：https://github.com/go-sql-driver/mysql
  - 特点：纯 Go 实现、性能优异、稳定维护；由 database/sql 管理连接池；支持 DSN、超时、TLS、LOAD DATA 读本地等；官方示例与最佳实践完善
  - 适配性：MySQL 5.7/8.0、MariaDB 10.5+；与 TiDB 兼容性良好（社区）
  - 结论：作为默认驱动

- database/sql 标准连接池
  - 特点：统一的池化模型（SetMaxOpen/Idle、SetConnMaxLifetime/IdleTime）；应用层实现读写分离/多数据源需自建封装
  - 结论：不引入第三方池，基于标准库封装治理与可观测

2.2 SQL 便捷层（扫描/命名参数/批量）
- jmoiron/sqlx（MIT）
  - 仓库：https://github.com/jmoiron/sqlx
  - 能力：Struct 映射、NamedExec/NamedQuery、Get/Select 快捷 API、Queryx/StructScan
  - 优势：保持与 database/sql 接口超集，一致性强，侵入小
  - 结论：优先选择（轻量且社区广泛）

- georgysavva/scany（MIT）
  - 仓库：https://github.com/georgysavva/scany
  - 能力：更专注扫描/映射（generics 友好），与 sqlx 类似但更轻
  - 结论：如希望更轻量的扫描功能可选

2.3 可观测性（Tracing/Metric/慢查询）
- XSAM/otelsql（MIT）
  - 仓库：https://github.com/XSAM/otelsql
  - 能力：对 database/sql 的 OpenTelemetry 链路与指标埋点；提供 db.sql.connection.* 指标与操作耗时；支持 SQL commenter
  - 结论：与我们“池借用/SQL 执行耗时”的指标需求高度契合

- sql.DBStats（标准库）
  - 能力：池级统计（Open/Idle/InUse/WaitCount/WaitDuration…）
  - 结论：与 otelsql 结合导出指标

2.4 测试与“内存型 MySQL”
- DATA-DOG/go-sqlmock（MIT）
  - 仓库：https://github.com/DATA-DOG/go-sqlmock
  - 能力：基于 database/sql 的 mock，按 SQL 模式/参数/结果精确断言
  - 适用：单元测试（无需真实数据库）

- testcontainers/testcontainers-go（MIT）
  - 仓库：https://github.com/testcontainers/testcontainers-go
  - 能力：在测试中以容器方式启动真实 MySQL，生命周期受控，端口随机化，适合并行测试
  - 适用：集成/端到端测试，验证真实行为与时序

- dolthub/go-mysql-server（Apache-2.0）
  - 仓库：https://github.com/dolthub/go-mysql-server
  - 能力：Go 实现的可嵌入 MySQL 兼容 SQL 引擎/服务器；支持内存引擎；实现 MySQL 协议
  - 优势：无需外部进程，启动快，可在单测中内存运行
  - 风险：与官方 MySQL 语法/行为存在差异（尤其边界/性能/锁语义），需验证兼容性
  - 结论：作为“内存型 MySQL”选项之一（需在兼容性较宽容的场景下采用）

- PingCAP/TiDB（Apache-2.0）
  - 仓库：https://github.com/pingcap/tidb
  - 能力：MySQL 协议兼容的分布式数据库；可在开发/测试使用内存或本地存储模式
  - 优势：兼容度较高，生态成熟
  - 代价：体量大、依赖多，不适合作为极轻量内存替身
  - 结论：不建议作为常规单测的内存替身，可作为高级场景的兼容性验证环境

2.5 迁移与数据夹具
- golang-migrate/migrate（MIT）
  - 仓库：https://github.com/golang-migrate/migrate
  - 能力：版本化迁移，支持多种源/目标，生态广
  - 结论：首选迁移引擎

- pressly/goose（MIT）
  - 仓库：https://github.com/pressly/goose
  - 能力：更简单直观，脚本与 Go 迁移并存
  - 结论：如团队更偏好 goose 风格可选

- Fixture Loader（自研）
  - 能力：基于 YAML/CSV/SQL 的夹具加载与 Reset/Teardown；结合事务或截断策略

2.6 查询构建与批量
- 直接 SQL + sqlx 命名参数/批量插入（VALUES (…) , (…)）
  - 优势：零抽象开销，最贴近驱动能力

- doug-martin/goqu（MIT）
  - 仓库：https://github.com/doug-martin/goqu
  - 能力：强大的 Query Builder，支持 MySQL 方言、Upsert、批量等

- Masterminds/squirrel（BSD-2）
  - 仓库：https://github.com/Masterminds/squirrel
  - 能力：轻量 Builder，链式构建 SQL，搭配 sqlx 使用

2.7 重试与错误分类
- cenkalti/backoff（MIT）
  - 仓库：https://github.com/cenkalti/backoff
  - 能力：指数退避/抖动/最大时长控制

- 错误分类（自研建议）
  - 基于 MySQL 错误码（如 1213 死锁、1205 锁等待超时、1290 只读…）划分“可重试/不可重试/冲突/约束”类别
  - 在事务边界内提供 WithinTx + 可重试策略（幂等保护）

### 3. 与需求的对应关系
- MySQL 驱动/连接池：go-sql-driver + database/sql；我们在其上封装 WithConn/Acquire/Conn.Close 自动归还、上下文超时、泄漏检测（基于借用时间阈值报警）
- 高效查询：
  - 预编译：复用 database/sql 的 per-connection prepared statement；必要时增加 LRU 语句缓存策略
  - 批量：原生多 VALUES、goqu/squirrel 辅助、sqlx NamedExec 支持批量结构体切片
  - 流式：提供 QueryStream 包装 rows.Next/Scan 回调或通道
  - 扫描与绑定：sqlx 或 scany
  - 错误分类与重试：结合 backoff 实现
- 事务：WithinTx 提供重试（死锁/只读）与 savepoint（可选）
- 观测：
  - otelsql + sql.DBStats 暴露池指标、SQL 耗时、错误；慢查询阈值采样上报
- 测试：
  - 单元：go-sqlmock
  - 集成：testcontainers-go（MySQL 官方镜像）
  - 内存型：dolthub/go-mysql-server（可选，需兼容性验证）
- 迁移/夹具：migrate/goose + 自研 Fixture Harness（NewTestDB、Reset、Teardown）

### 4. 许可与合规（简表）
- go-sql-driver/mysql：MPL-2.0（修改后需开源修改部分；未修改可闭源使用）
- sqlx、scany、otelsql、migrate、goose、goqu、squirrel、sqlmock、testcontainers-go、backoff：多为 MIT/BSD/Apache-2.0，商业友好
- dolthub/go-mysql-server：Apache-2.0

建议：驱动作为 MPL-2.0，避免直接修改其源码；如需扩展，通过外部封装实现。

### 5. 集成方案草图
- 模块：mysqlx（我们自研）
  - Config（DSN/池参数/重试策略/观测开关）
  - Pool（包装 *sql.DB，集成 otelsql，导出 DBStats 指标）
  - Conn（WithConn/Acquire/Close 自动归还，标签/上下文超时）
  - Tx（WithinTx/BeginTx，死锁/只读重试）
  - Query APIs（Query/Exec/QueryStream/NamedExec，结合 sqlx 或 scany 扫描）
  - StmtCache（可选 LRU）
  - TestHarness（sqlmock | testcontainers | go-mysql-server）

### 6. 主要风险与规避
- “内存型 MySQL”兼容性风险：
  - 规避：默认使用 testcontainers 启动真实 MySQL；内存型仅用于极快单测或特定场景，并配套兼容性用例对齐
- 读写分离与一致性：
  - 规避：首期不内置复杂策略，仅提供主/从多数据源接口；后续再引入一致性等级与路由策略
- 预编译缓存错误与资源泄漏：
  - 规避：先用 database/sql 默认行为；缓存采用容量限制 + 自动清理；集成泄漏检测与告警

### 7. 下一步工作
- 确认首期依赖清单：mysql driver + sqlx + otelsql + (sqlmock|testcontainers) + migrate
- 产出 PoC：
  - Pool/Conn/Tx 最小实现 + 指标暴露 + WithinTx 重试
  - Query/Scan/NamedExec 示例 + 批量/流式 Demo
  - TestHarness：sqlmock 与 testcontainers 双路径样例
- 建立基准测试与兼容性用例：
  - 连接池借用/归还、简单查询 P95
  - 死锁/只读重试场景
  - go-mysql-server 与真实 MySQL 的差异用例（如采纳内存型）

### 8. 参考链接（部分）
- go-sql-driver/mysql（README/用法/参数）：https://github.com/go-sql-driver/mysql
- SQL Benchmark（历史对比）：https://github.com/go-sql-driver/sql-benchmark
- sqlx：https://github.com/jmoiron/sqlx
- scany：https://github.com/georgysavva/scany
- otelsql：https://github.com/XSAM/otelsql
- testcontainers-go：https://github.com/testcontainers/testcontainers-go
- go-sqlmock：https://github.com/DATA-DOG/go-sqlmock
- go-mysql-server：https://github.com/dolthub/go-mysql-server
- golang-migrate/migrate：https://github.com/golang-migrate/migrate
- pressly/goose：https://github.com/pressly/goose
- goqu：https://github.com/doug-martin/goqu
- squirrel：https://github.com/Masterminds/squirrel
- backoff：https://github.com/cenkalti/backoff

