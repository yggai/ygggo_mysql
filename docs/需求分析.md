## MySQL 通用底层框架 需求分析（v1.0）

- 文档状态：草案（可作为基线文档）
- 修订日期：2025-08-14
- 面向读者：架构师、后端工程师、测试工程师、运维工程师
- 技术栈：Go 1.21+，MySQL 5.7/8.0，兼容 MariaDB（有限）

### 1. 项目背景与愿景
- 背景：当前各服务对 MySQL 的使用分散、模式不统一，连接池、重试、日志、测试环境维护成本高。
- 愿景：提供一个统一、稳定、可测试、可观测的 MySQL 底层框架，最小化上层业务心智负担。

### 2. 范围与非范围
- 范围：
  - 基于 MySQL 驱动的连接与连接池管理；
  - 自动管理的“连接对象”（从池获取/归还、泄漏防护、上下文化）；
  - 高效查询方法（预编译缓存、批量/流式、便捷扫描、幂等重试）；
  - 测试工具（内存型 MySQL/模拟器 或 临时数据库、数据夹具、迁移支持）；
  - 可观测性（日志、指标、Tracing、慢查询与池耗时统计）；
  - 配置体系与运行时健康检查、优雅退出；
- 非范围（本期不含）：
  - 全功能 ORM；
  - 跨数据库方言抽象（仅以 MySQL 为一等公民）；
  - 数据迁移框架本身（可提供 Hook 与示例集成）。

### 3. 目标
- 功能目标：
  1) 统一连接池参数与生命周期管理；
  2) 提供易用的查询/执行 API（减少样板代码与资源泄露风险）；
  3) 提供事务与重试语义，支持死锁/临时错误自动重试；
  4) 提供可用的“内存型 MySQL 测试路径”与一键化测试基架；
  5) 对接日志/指标/Tracing，便于定位问题与容量规划。
- 体验目标：
  - 典型读写功能 10 行内完成；事务操作 15 行内完成；
  - 连接泄漏 0 容忍（具备检测与告警）；
- 性能目标（初始）：
  - P95 池借用耗时 ≤ 2ms；
  - P95 简单查询总耗时（不含服务器端执行）≤ 5ms；
  - 连接复用率 ≥ 95%；预编译命中率 ≥ 90%。

### 4. 核心功能需求
4.1 驱动与连接管理
- 兼容 go-sql-driver/mysql，支持 DSN/结构化配置；
- 连接池参数：最大空闲/最大连接、连接存活时长、连接空闲超时、连接保活；
- 启动自检（Ping/版本/时区/字符集），运行期健康检查；
- 多数据源支持（主写、只读从库组，后续可选读写分离策略与权重）。

4.2 基于池的自动管理“连接对象”
- 提供 WithConn(ctx, fn) / Acquire(ctx)->Conn / Conn.Close() 自动归还；
- 支持上下文取消、超时、SQL 级别超时；
- 泄漏检测（借用超时未归还告警、调用栈快照）；
- 连接标签（用于观测与路由，例如 rw=read/ write）。

4.3 高效查询方法
- 预编译语句缓存（LRU、逐连接或全局策略）；
- 命名参数与占位符绑定工具；
- 批量能力：BulkInsert、BatchExec、InsertOnDuplicate（Upsert）；
- 流式查询：QueryStream(ctx, sql, args...)，按行回调/通道消费；
- 结果扫描：
  - 轻量映射（行->struct/map/基本类型），支持泛型与列名标签；
  - 空值与时间/JSON/decimal 安全处理；
- 错误分级：可重试/不可重试/数据冲突/约束错误分类；
- 幂等重试：对可重试错误采用指数退避，限制最大尝试次数与总时长。

4.4 事务（Tx）
- BeginTx(ctx, opts) 与 WithinTx(ctx, fn, opts) 模式；
- 死锁/锁等待超时自动重试（幂等保护、重试策略可配置）；
- Savepoint（可选，提供简单包装）；
- 自动回滚（未显式 Commit 时），确保资源安全释放。

4.5 测试与“内存型 MySQL”
- 目标：让单测/集成测无需手工部署数据库，或数据库生命周期自动化；
- 模式：
  1) 内存型 MySQL 模式（优先）：基于兼容 MySQL 协议/语法的内存后端（如可选 TiDB 内存存储、模拟驱动），用于快速单测；
  2) 临时数据库模式：启动临时 MySQL/MariaDB（本地或容器），自动建库/迁移/回收；
- 提供 TestHarness：
  - NewTestDB()：创建隔离测试库、执行迁移与夹具；
  - Reset()/Teardown()：数据重置与资源回收；
  - FakeClock/故障注入（可选）用于稳定性测试；
- 测试便捷工具：
  - MustQuery/MustExec、Golden 校验、随机数据生成、行计数断言；
  - 并发冲突与死锁场景的可重复构造。

4.6 可观测性与治理
- 日志：SQL 模板、绑定参数（受隐私策略控制）、耗时、影响行数、错误码；
- 指标：池借用/归还耗时直方图、活跃连接数、等待队列长度、SQL 执行耗时；
- Trace：对接 OpenTelemetry，Span 覆盖连接获取与 SQL 执行；
- 慢查询：阈值上报与采样；
- 治理：可选熔断/限流/降级策略（例如只读强制到从库）。

4.7 配置与运维
- 配置来源：YAML/ENV/代码注入，支持热更新（谨慎：涉及池大小变更的平滑过渡）；
- 凭证管理：支持 TLS、CA 校验、最小权限账户；
- 优雅退出：进程停止前阻断新借用、等待活动连接归还、超时强制回收；
- 兼容性：字符集 utf8mb4、统一时区策略、sql_mode 显式化。

### 5. 非功能需求
- 性能：
  - 单连接 QPS 基线 ≥ 2k（简单查询，驱动层不成为瓶颈）；
  - 100 并发下池等待 P95 ≤ 5ms；
- 可靠性：
  - 连接泄漏 0；断线自动重连可控；
  - 重试不违反事务边界与幂等性；
- 安全：
  - 禁止拼接 SQL 注入风险（统一占位符绑定）；
  - 敏感参数与日志脱敏；全链路 TLS 可选；
- 可用性：可用性 ≥ 99.9%，具备健康检查与自愈策略；
- 可维护性：
  - API 稳定（语义化版本）；
  - 完整文档与示例；
  - 单测覆盖率 ≥ 70%，关键路径 ≥ 90%。

### 6. API 设计草案（Go）
- 包与核心类型：
  - package mysqlx
  - type Pool, Conn, Tx, StmtCache, Config, RetryPolicy
  - type TestHarness, Fixture
- 关键方法（示意）：
  - NewPool(cfg Config) (*Pool, error)
  - (*Pool) WithConn(ctx, func(Conn) error) error
  - (Conn) Query/QueryRow/Exec/QueryStream
  - (Conn) BulkInsert(ctx, table string, columns []string, rows [][]any) (int, error)
  - (Pool) WithinTx(ctx, opts TxOpts, fn func(Tx) error) error
  - (Pool) ReadOnly()/WriteOnly() 视图（可选读写分离）
  - NamedQuery/Scan/ScanAll 辅助

### 7. 配置示例（草案）
- YAML：
  - dsn: "user:pass@tcp(host:3306)/db?parseTime=true&charset=utf8mb4"
  - pool:
    - maxOpen: 100
    - maxIdle: 20
    - connMaxLifetime: 30m
    - connMaxIdleTime: 5m
  - retry:
    - maxAttempts: 3
    - baseBackoff: 50ms
    - maxBackoff: 1s
  - telemetry:
    - enable: true
    - slowQueryThreshold: 200ms

### 8. 里程碑与交付
- M1（核心）：Pool/Conn/Tx、配置、基础查询/扫描、指标与日志基线、WithinTx；
- M2（效率）：Stmt 缓存、批量/Upsert、流式、错误分类与重试、慢查询；
- M3（测试）：内存型 MySQL/临时库 TestHarness、数据夹具、并发与故障注入；
- M4（增强）：读写分离、热更新、治理策略、更多示例与性能基准；
- 交付物：README、API 文档、示例项目、基准报告、测试报告。

### 9. 验收标准
- 功能：API 用例通过率 ≥ 95%，事务/重试/批量等关键用例 100%；
- 性能：基准测试达到目标阈值；
- 稳定性：压测 24h 无连接泄漏与资源飙升；
- 兼容性：MySQL 5.7/8.0 均通过集成测试；
- 可观测性：关键指标可见，慢查询可追踪。

### 10. 风险与假设
- 风险：
  - “内存型 MySQL”实现路径的不确定性（兼容性、维护成本）；
  - 读写分离与一致性策略复杂度；
- 缓解：
  - 首期提供临时数据库模式做兜底；
  - 将内存型实现模块化，可替换/关闭；
- 假设：
  - 允许引入 go-sql-driver/mysql 与 OpenTelemetry 相关依赖；
  - CI 可运行容器或本地 MySQL 服务。

### 11. 开放问题
- 内存型 MySQL 的具体实现选择（模拟驱动、TiDB 内存、或容器化临时库）？
- 是否需要内置最小化 Query Builder，还是仅提供扫描与绑定工具？
- 是否支持读写分离与一致性等级配置（读延迟可接受范围）？
- 是否需要与现有迁移工具（如 goose、golang-migrate）深度集成？

