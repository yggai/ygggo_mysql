# 慢查询记录功能

## 概述

ygggo_mysql 提供了强大的慢查询记录和分析功能，帮助开发者识别、分析和优化数据库性能问题。该功能支持多种存储方式、详细的统计分析和智能的优化建议。

## 核心特性

### 🚀 主要功能

- **自动检测和记录**：自动检测超过阈值的慢查询
- **多种存储方式**：支持内存存储和文件存储
- **查询标准化**：自动标准化查询模式，便于分析
- **统计分析**：提供详细的性能统计和趋势分析
- **智能建议**：基于查询模式提供优化建议
- **灵活配置**：支持动态配置调整
- **安全性**：支持参数脱敏和堆栈信息记录

### 📊 分析能力

- **查询模式识别**：识别相似查询并进行聚合分析
- **性能趋势**：时间分布分析和性能趋势
- **百分位统计**：P95、P99等百分位性能指标
- **频率分析**：最频繁的慢查询模式
- **优化建议**：基于查询模式的自动优化建议

## 快速开始

### 基本使用

```go
package main

import (
    "context"
    "time"
    "github.com/yggai/ygggo_mysql"
)

func main() {
    ctx := context.Background()
    
    // 创建数据库连接池
    pool, err := ygggo_mysql.NewPool(ctx, ygggo_mysql.Config{
        // 数据库配置...
    })
    if err != nil {
        panic(err)
    }
    defer pool.Close()
    
    // 创建内存存储
    storage := ygggo_mysql.NewMemorySlowQueryStorage(1000)
    
    // 配置慢查询记录
    config := ygggo_mysql.DefaultSlowQueryConfig()
    config.Enabled = true
    config.Threshold = 100 * time.Millisecond
    config.SanitizeArgs = true
    
    // 启用慢查询记录
    pool.EnableSlowQueryRecording(config, storage)
    
    // 执行数据库操作...
    // 慢查询会自动被记录
    
    // 获取慢查询记录器
    recorder := pool.GetSlowQueryRecorder()
    
    // 查看记录的慢查询
    records, err := recorder.GetRecords(ctx, ygggo_mysql.SlowQueryFilter{})
    if err != nil {
        panic(err)
    }
    
    for _, record := range records {
        fmt.Printf("慢查询: %s, 耗时: %v\n", record.Query, record.Duration)
    }
}
```

## 配置选项

### SlowQueryConfig

```go
type SlowQueryConfig struct {
    Enabled           bool          // 是否启用慢查询记录
    Threshold         time.Duration // 慢查询阈值
    MaxRecords        int           // 最大记录数量
    MaxPatterns       int           // 最大查询模式数量
    SanitizeArgs      bool          // 是否脱敏查询参数
    IncludeStack      bool          // 是否包含调用堆栈
    NormalizationMode string        // 查询标准化模式
}
```

### 默认配置

```go
config := ygggo_mysql.DefaultSlowQueryConfig()
// Enabled: false
// Threshold: 100ms
// MaxRecords: 1000
// MaxPatterns: 100
// SanitizeArgs: true
// IncludeStack: false
// NormalizationMode: "basic"
```

## 存储方式

### 1. 内存存储

适用于开发和测试环境，数据存储在内存中，重启后丢失。

```go
// 创建内存存储，最多保存1000条记录
storage := ygggo_mysql.NewMemorySlowQueryStorage(1000)
```

**特点**：
- ✅ 性能最佳
- ✅ 无磁盘IO
- ❌ 重启后数据丢失
- ❌ 内存占用

### 2. 文件存储

适用于生产环境，数据持久化到文件，支持日志轮转。

```go
// 创建文件存储，最大文件大小1MB
storage, err := ygggo_mysql.NewFileSlowQueryStorage("slow_queries.log", 1024*1024)
if err != nil {
    panic(err)
}
defer storage.Close()
```

**特点**：
- ✅ 数据持久化
- ✅ 支持日志轮转
- ✅ 重启后数据保留
- ❌ 磁盘IO开销

## 查询和分析

### 基本查询

```go
// 获取所有慢查询记录
records, err := recorder.GetRecords(ctx, ygggo_mysql.SlowQueryFilter{})

// 按条件过滤
filter := ygggo_mysql.SlowQueryFilter{
    MinDuration: &[]time.Duration{200 * time.Millisecond}[0],
    Limit:       10,
}
records, err = recorder.GetRecords(ctx, filter)
```

### 统计信息

```go
// 获取统计信息
stats, err := recorder.GetStats(ctx)
if err != nil {
    panic(err)
}

fmt.Printf("总慢查询数: %d\n", stats.TotalCount)
fmt.Printf("唯一查询模式: %d\n", stats.UniqueQueries)
fmt.Printf("平均耗时: %v\n", stats.AverageDuration)
fmt.Printf("最大耗时: %v\n", stats.MaxDuration)
```

### 查询模式分析

```go
// 获取最频繁的查询模式
patterns, err := recorder.GetPatterns(ctx, 10)
if err != nil {
    panic(err)
}

for _, pattern := range patterns {
    fmt.Printf("模式: %s\n", pattern.NormalizedQuery)
    fmt.Printf("出现次数: %d\n", pattern.Count)
    fmt.Printf("平均耗时: %v\n", pattern.AverageDuration)
}
```

## 高级分析

### 生成分析报告

```go
analyzer := ygggo_mysql.NewSlowQueryAnalyzer(storage)
report, err := analyzer.GenerateReport(ctx, ygggo_mysql.SlowQueryFilter{})
if err != nil {
    panic(err)
}

// 查看摘要
fmt.Printf("总查询数: %d\n", report.Summary.TotalQueries)
fmt.Printf("平均耗时: %v\n", report.Summary.AverageDuration)
fmt.Printf("P95耗时: %v\n", report.Summary.P95Duration)
fmt.Printf("P99耗时: %v\n", report.Summary.P99Duration)

// 查看优化建议
for _, rec := range report.Recommendations {
    fmt.Printf("建议: %s\n", rec)
}
```

### 时间分布分析

```go
// 分析报告包含时间分布信息
for _, slot := range report.TimeDistribution {
    fmt.Printf("时间段: %v - %v\n", slot.StartTime, slot.EndTime)
    fmt.Printf("查询数量: %d\n", slot.QueryCount)
    fmt.Printf("平均耗时: %v\n", slot.AverageTime)
}
```

## 过滤选项

### SlowQueryFilter

```go
type SlowQueryFilter struct {
    StartTime    *time.Time    // 开始时间
    EndTime      *time.Time    // 结束时间
    MinDuration  *time.Duration // 最小耗时
    MaxDuration  *time.Duration // 最大耗时
    QueryPattern string        // 查询模式匹配
    Database     string        // 数据库名称
    Limit        int           // 限制数量
    Offset       int           // 偏移量
}
```

### 使用示例

```go
// 查询最近1小时的慢查询
startTime := time.Now().Add(-time.Hour)
filter := ygggo_mysql.SlowQueryFilter{
    StartTime: &startTime,
    Limit:     50,
}

// 查询耗时超过500ms的查询
minDuration := 500 * time.Millisecond
filter = ygggo_mysql.SlowQueryFilter{
    MinDuration: &minDuration,
}

// 查询包含特定模式的查询
filter = ygggo_mysql.SlowQueryFilter{
    QueryPattern: "SELECT * FROM",
}
```

## 配置管理

### 动态配置调整

```go
// 获取当前配置
config := recorder.GetConfig()

// 修改配置
config.Threshold = 200 * time.Millisecond
config.SanitizeArgs = false

// 更新配置
recorder.UpdateConfig(config)

// 或者单独设置
recorder.SetThreshold(150 * time.Millisecond)
recorder.SetEnabled(true)
```

### 阈值管理

```go
// 设置慢查询阈值（同时影响日志记录和慢查询记录）
pool.SetSlowQueryThreshold(100 * time.Millisecond)

// 获取当前阈值
threshold := pool.GetSlowQueryThreshold()
```

## 最佳实践

### 1. 生产环境配置

```go
config := ygggo_mysql.SlowQueryConfig{
    Enabled:           true,
    Threshold:         200 * time.Millisecond, // 根据业务需求调整
    MaxRecords:        5000,                   // 适当增加记录数量
    MaxPatterns:       200,                    // 增加模式数量
    SanitizeArgs:      true,                   // 生产环境建议启用
    IncludeStack:      false,                  // 生产环境建议关闭
    NormalizationMode: "basic",
}

// 使用文件存储
storage, err := ygggo_mysql.NewFileSlowQueryStorage(
    "/var/log/app/slow_queries.log", 
    10*1024*1024, // 10MB
)
```

### 2. 开发环境配置

```go
config := ygggo_mysql.SlowQueryConfig{
    Enabled:           true,
    Threshold:         50 * time.Millisecond,  // 更低的阈值
    MaxRecords:        1000,
    MaxPatterns:       100,
    SanitizeArgs:      false,                  // 开发环境可以关闭
    IncludeStack:      true,                   // 开发环境可以启用
    NormalizationMode: "basic",
}

// 使用内存存储
storage := ygggo_mysql.NewMemorySlowQueryStorage(1000)
```

### 3. 性能考虑

- **阈值设置**：根据业务需求合理设置阈值，避免记录过多正常查询
- **存储容量**：定期清理或轮转日志文件，避免磁盘空间不足
- **参数脱敏**：生产环境建议启用参数脱敏，保护敏感数据
- **堆栈信息**：仅在调试时启用堆栈信息记录，避免性能影响

### 4. 监控和告警

```go
// 定期检查慢查询统计
go func() {
    ticker := time.NewTicker(5 * time.Minute)
    defer ticker.Stop()
    
    for range ticker.C {
        stats, err := recorder.GetStats(ctx)
        if err != nil {
            continue
        }
        
        // 如果慢查询数量过多，发送告警
        if stats.TotalCount > 1000 {
            // 发送告警...
        }
        
        // 如果平均耗时过长，发送告警
        if stats.AverageDuration > 500*time.Millisecond {
            // 发送告警...
        }
    }
}()
```

## 故障排查

### 常见问题

1. **慢查询没有被记录**
   - 检查是否启用：`recorder.IsEnabled()`
   - 检查阈值设置：`recorder.GetThreshold()`
   - 确认查询耗时确实超过阈值

2. **记录数量过多**
   - 调整阈值：提高慢查询阈值
   - 限制记录数量：设置合适的 `MaxRecords`
   - 定期清理：调用 `recorder.Clear(ctx)`

3. **文件存储问题**
   - 检查文件权限
   - 检查磁盘空间
   - 确认文件路径存在

### 调试技巧

```go
// 启用详细日志
pool.EnableLogging(true)
pool.SetLogger(slog.New(slog.NewTextHandler(os.Stdout, &slog.HandlerOptions{
    Level: slog.LevelDebug,
})))

// 检查配置
config := recorder.GetConfig()
fmt.Printf("配置: %+v\n", config)

// 检查统计信息
stats, _ := recorder.GetStats(ctx)
fmt.Printf("统计: %+v\n", stats)
```

## 示例代码

完整的示例代码请参考：[examples/slow_query_example.go](../examples/slow_query_example.go)

该示例展示了：
- 基本的慢查询记录
- 统计信息获取
- 高级分析功能
- 文件存储使用
- 配置管理
- 查询过滤

## 总结

慢查询记录功能为数据库性能优化提供了强大的工具。通过合理配置和使用，可以有效识别性能瓶颈，指导优化工作，提升应用性能。
