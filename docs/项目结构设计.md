## 项目结构设计（扁平化方案 v1.0）

- 项目名：ygggo_mysql
- 模块路径：github.com/yggai/ygggo_mysql
- 设计目标：扁平化、开箱即用。尽量将可复用代码直接放在根包（package ygggo_mysql）下，避免用户导入多个子包。

### 1. 顶层结构（建议）
- 根目录仅包含：
  - 包代码（.go）：核心类型与 API 均在根包导出
  - 文档（docs/）：需求/调研/计划/结构设计等
  - 示例（examples/）：可运行示例，不参与库编译
  - 辅助文件：README、LICENSE、CHANGELOG、go.mod、Makefile、.github/

参考布局示意：
- ygggo_mysql.go（包入口与对外导出的核心类型/函数）
- config.go（配置定义与加载）
- pool.go（连接池封装、WithConn/Acquire/Close）
- conn.go（连接对象、上下文超时、标签、泄漏检测）
- tx.go（事务、WithinTx、Savepoint 可选）
- stmt_cache.go（预编译缓存 LRU）
- query.go（Exec/Query/Get/Select/NamedExec、QueryStream）
- scan.go（扫描与绑定工具，泛型支持）
- retry.go（重试策略与错误分类）
- errors.go（库内错误与 MySQL 错误码分类）
- telemetry.go（otelsql 接入、指标/慢查询采样）
- fixtures.go（测试夹具工具，仅构建标签 or 内部使用）
- harness_test.go / harness.go（TestHarness：sqlmock/testcontainers 封装；测试/示例用）
- examples/
  - basic_conn/main.go
  - basic_query/main.go
  - tx_retry/main.go
  - stream_query/main.go

说明：
- 不使用 internal/ 与多层目录，所有库功能集中在根包，examples/ 与 docs/ 为非库目录。
- e2e 与测试基架相关工具如需对外提供（便于用户测试自己的代码），可提供受限导出（例如 NewTestDB 仅在 test build tag 下可见），或放在 examples/ 与文档中。

### 2. 包命名与导出 API 规划
- 包名：ygggo_mysql（import "github.com/yggai/ygggo_mysql"）
- 导出核心类型：
  - type Config struct { DSN string; Pool PoolConfig; Retry RetryPolicy; Telemetry TelemetryConfig; SlowQuery time.Duration; ... }
  - type Pool struct { ... } // 线程安全、复用 *sql.DB
  - type Conn struct { ... } // 代表一次借用的连接，必须 Close 归还（WithConn 自动）
  - type Tx struct { ... }
  - type StmtCache struct { ... }
  - type RetryPolicy struct { MaxAttempts int; BaseBackoff time.Duration; MaxBackoff time.Duration; Jitter bool; ... }
- 导出函数：
  - func NewPool(ctx context.Context, cfg Config) (*Pool, error)
  - func (p *Pool) Close() error
  - func (p *Pool) WithConn(ctx context.Context, fn func(c *Conn) error) error
  - func (p *Pool) Acquire(ctx context.Context) (*Conn, error)
  - func (c *Conn) Close() error
  - func (c *Conn) Exec(ctx context.Context, query string, args ...any) (sql.Result, error)
  - func (c *Conn) Query(ctx context.Context, query string, args ...any) (*Rows, error)
  - func (c *Conn) QueryRow(ctx context.Context, query string, args ...any) *Row
  - func (c *Conn) QueryStream(ctx context.Context, query string, args ...any, cb func(Row) error) error
  - func (p *Pool) WithinTx(ctx context.Context, fn func(tx *Tx) error, opts ...TxOption) error
  - 批量与 Upsert：func (c *Conn) BulkInsert(...); func (c *Conn) InsertOnDuplicate(...)
  - 命名参数：func Named(query string, arg any) (string, []any, error)
  - 观测与指标：func (p *Pool) Stats() sql.DBStats
- 错误与分类：
  - var ErrRetryable, ErrConflict, ErrReadonly, ErrConstraint 等
  - func Classify(err error) ErrorClass

注：Rows/Row 可直接透传 *sql.Rows/*sql.Row 或提供轻量包装；扫描能力可与 sqlx 集成：
- func Get[T any](ctx context.Context, c *Conn, dest *T, query string, args ...any) error
- func Select[T any](ctx context.Context, c *Conn, dest *[]T, query string, args ...any) error

### 3. 依赖与可选组件
- 直接依赖：
  - github.com/go-sql-driver/mysql（驱动）
  - github.com/jmoiron/sqlx（扫描与便捷 API）
  - github.com/XSAM/otelsql（OpenTelemetry）
  - github.com/cenkalti/backoff/v4（重试）
- 仅测试/示例依赖：
  - github.com/DATA-DOG/go-sqlmock
  - github.com/testcontainers/testcontainers-go
  - 迁移工具：github.com/golang-migrate/migrate/v4 或 github.com/pressly/goose
- 可选：dolthub/go-mysql-server（作为“内存型 MySQL”实验性依赖，不作为强依赖）

### 4. 代码组织与构建策略
- 扁平化不代表文件臃肿：按领域拆分为若干 .go 文件，使用 build tag 控制测试/示例特性（如 e2e 或内存型集成）。
- examples/ 单独目录，用户可 golang install 或 go run。
- 严控导出面：只导出对用户有价值的类型/函数，内部细节非导出（小写）。
- 通过 go:generate（可选）生成部分样板（如错误码表或 SQL 模板），生成文件也在根包。

### 5. 使用姿势（示例）
- 导入：
  import "github.com/yggai/ygggo_mysql"
- 初始化：
  pool, _ := ygggo_mysql.NewPool(ctx, cfg)
- 查询：
  err := pool.WithConn(ctx, func(c *ygggo_mysql.Conn) error {
      var user User
      return ygggo_mysql.Get(ctx, c, &user, "SELECT * FROM users WHERE id=?", id)
  })
- 事务：
  err := pool.WithinTx(ctx, func(tx *ygggo_mysql.Tx) error { ... })

### 6. 观测与日志建议
- TelemetryConfig 控制是否通过 otelsql 包装驱动；
- SlowQuery 阈值触发结构化日志（包含模板、绑定参数摘要、耗时、影响行数、分类）；
- 提供 Hook：BeforeQuery/AfterQuery 便于用户自定义埋点或审计。

### 7. 版本与兼容性
- 语义化版本，根包 API 稳定后发布 v1；
- 坚持根包导出，避免未来再进行大规模包结构调整；
- 对测试/实验能力使用 build tag + 文档标注，避免影响主包消费者。

