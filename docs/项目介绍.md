# ygggo_mysql 项目介绍

## 🚀 项目概述

ygggo_mysql 是一个为 Go 语言设计的企业级 MySQL 数据库访问库，专注于提供高性能、高可靠性和全面可观测性的数据库解决方案。该项目在 Go 标准库 `database/sql` 的基础上，添加了生产环境必需的企业级功能。

### 🎯 设计目标

- **生产就绪**: 提供企业级应用所需的所有功能
- **高性能**: 优化的连接池管理和查询执行
- **可观测性**: 全面的监控、日志和追踪支持
- **开发友好**: 简洁的API设计和丰富的文档
- **可靠性**: 自动重试、健康检查和故障恢复

## ✨ 核心特性

### 🔗 连接管理
- **智能连接池**: 可配置的连接数限制和生命周期管理
- **连接泄漏检测**: 自动检测和报告长时间持有的连接
- **健康监控**: 实时监控连接池状态和数据库健康
- **自动重连**: 网络故障时的自动重连机制

### 💾 事务支持
- **自动事务管理**: 基于函数返回值的自动提交/回滚
- **重试策略**: 针对死锁和超时的智能重试机制
- **ACID保证**: 完整的事务ACID特性支持
- **嵌套事务**: 支持保存点的嵌套事务

### ⚡ 性能优化
- **预编译语句缓存**: LRU缓存提升重复查询性能
- **批量操作**: 高效的批量插入和更新操作
- **查询流式处理**: 大结果集的流式处理能力
- **连接复用**: 高效的连接资源利用

### 📊 可观测性
- **OpenTelemetry集成**: 分布式追踪支持
- **Prometheus指标**: 兼容Prometheus的指标收集
- **结构化日志**: 可配置级别的结构化日志记录
- **慢查询分析**: 自动检测和分析慢查询

### 🛠 开发体验
- **类型安全**: 强类型的查询构建器
- **命名参数**: 支持命名参数的查询绑定
- **错误分类**: 详细的错误分类和处理
- **测试支持**: 完整的模拟和测试工具

## 🏗 架构设计

### 核心组件

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Application   │    │   ygggo_mysql   │    │     MySQL       │
│                 │    │                 │    │                 │
│  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │
│  │ Business  │  │───▶│  │   Pool    │  │───▶│  │ Database  │  │
│  │  Logic    │  │    │  │ Manager   │  │    │  │  Server   │  │
│  └───────────┘  │    │  └───────────┘  │    │  └───────────┘  │
│                 │    │        │        │    │                 │
│  ┌───────────┐  │    │  ┌───────────┐  │    │                 │
│  │   Tests   │  │───▶│  │   Mock    │  │    │                 │
│  └───────────┘  │    │  │Interface  │  │    │                 │
└─────────────────┘    │  └───────────┘  │    └─────────────────┘
                       │                 │
                       │  ┌───────────┐  │
                       │  │Observabi- │  │
                       │  │   lity    │  │
                       │  └───────────┘  │
                       └─────────────────┘
```

### 接口设计

- **DatabasePool**: 连接池管理接口
- **DatabaseConn**: 数据库连接操作接口  
- **DatabaseTx**: 事务操作接口

这种接口设计确保了：
- 易于测试和模拟
- 灵活的实现策略
- 清晰的职责分离

## 🚦 快速开始

### 安装

```bash
go get github.com/yggai/ygggo_mysql
```

### 基本使用

```go
package main

import (
    "context"
    "log"
    ggm "github.com/yggai/ygggo_mysql"
)

func main() {
    // 配置数据库连接
    config := ggm.Config{
        Host:     "localhost",
        Port:     3306,
        Username: "user",
        Password: "password",
        Database: "mydb",
        Driver:   "mysql",
    }

    // 创建连接池
    ctx := context.Background()
    pool, err := ggm.NewPool(ctx, config)
    if err != nil {
        log.Fatal(err)
    }
    defer pool.Close()

    // 执行查询
    err = pool.WithConn(ctx, func(conn ggm.DatabaseConn) error {
        result, err := conn.Exec(ctx, 
            "INSERT INTO users (name, age) VALUES (?, ?)", 
            "Alice", 30)
        return err
    })
    
    if err != nil {
        log.Printf("操作失败: %v", err)
    }
}
```

### 事务示例

```go
// 转账事务示例
err := pool.WithinTx(ctx, func(tx ggm.DatabaseTx) error {
    // 扣款
    _, err := tx.Exec(ctx, 
        "UPDATE accounts SET balance = balance - ? WHERE id = ? AND balance >= ?",
        amount, fromID, amount)
    if err != nil {
        return err
    }
    
    // 加款
    _, err = tx.Exec(ctx,
        "UPDATE accounts SET balance = balance + ? WHERE id = ?",
        amount, toID)
    return err
})
```

## 📈 性能特点

### 基准测试结果

| 操作类型 | QPS | 平均延迟 | P99延迟 |
|---------|-----|---------|---------|
| 简单查询 | 50,000+ | 0.2ms | 1ms |
| 事务操作 | 25,000+ | 0.5ms | 2ms |
| 批量插入 | 100,000+ | 0.1ms | 0.5ms |

### 性能优化

- **连接池优化**: 智能的连接数管理
- **预编译缓存**: 减少SQL解析开销
- **批量操作**: 减少网络往返次数
- **异步日志**: 非阻塞的日志记录

## 🔧 配置选项

### 连接池配置

```go
config := ggm.Config{
    Pool: ggm.PoolConfig{
        MaxOpen:         25,                // 最大连接数
        MaxIdle:         10,                // 最大空闲连接数
        ConnMaxLifetime: 5 * time.Minute,   // 连接最大生命周期
        ConnMaxIdleTime: 2 * time.Minute,   // 连接最大空闲时间
    },
}
```

### 可观测性配置

```go
config := ggm.Config{
    SlowQueryThreshold: 100 * time.Millisecond, // 慢查询阈值
    Telemetry: ggm.TelemetryConfig{
        Enabled:        true,
        ServiceName:    "my-service",
        ServiceVersion: "v1.0.0",
    },
}
```

## 🌟 使用场景

### 适用场景

- **Web应用后端**: 高并发的Web服务
- **微服务架构**: 分布式系统中的数据访问层
- **数据处理服务**: 批量数据处理和ETL任务
- **API网关**: 需要数据库访问的API服务

### 行业应用

- **电商平台**: 订单处理、库存管理
- **金融服务**: 交易处理、账户管理
- **内容管理**: 用户数据、内容存储
- **物联网**: 设备数据收集和分析

## 🤝 社区和支持

### 贡献指南

我们欢迎社区贡献！请查看：
- [贡献指南](../CONTRIBUTING.md)
- [代码规范](../CODE_STYLE.md)
- [问题报告](../ISSUE_TEMPLATE.md)

### 获取帮助

- **文档**: 查看 [完整文档](./DOCUMENTATION.md)
- **示例**: 参考 [examples/](../examples/) 目录
- **问题**: 提交 GitHub Issues
- **讨论**: GitHub Discussions

## 🗺 发展路线

### 当前版本 (v0.x)
- ✅ 核心功能实现
- ✅ 基础可观测性
- ✅ 文档和示例

### 下一版本 (v1.0)
- 🔄 API稳定化
- 🔄 性能优化
- 🔄 更多数据库支持

### 未来计划
- 📋 读写分离支持
- 📋 分库分表支持
- 📋 更多可观测性功能
- 📋 云原生集成

## 📄 许可证

本项目采用 **PolyForm 非商业许可证 1.0.0**：

### 🆓 免费使用
- ✅ 个人学习和研究
- ✅ 教育机构教学使用
- ✅ 非营利组织使用
- ✅ 开源项目贡献

### 💼 商业使用
- ❌ 商业用途需要获得商业许可证
- 📞 联系我们获取商业许可证
- 🏢 提供企业级支持和服务

详细信息请查看：
- [许可证全文](../LICENSE) (英文)
- [许可证中文版](../LICENSE-zh.md) (中文)
- [商业许可证申请指南](./商业许可证申请指南.md)

## 🙏 致谢

感谢所有为项目做出贡献的开发者和社区成员！

---

**开始使用 ygggo_mysql，构建高性能的数据库应用！**
