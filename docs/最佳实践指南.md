# ygggo_mysql æœ€ä½³å®è·µæŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—æä¾›äº†ä½¿ç”¨ ygggo_mysql åº“çš„æœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…é¿å…å¸¸è§é™·é˜±ï¼Œç¼–å†™é«˜æ•ˆã€å®‰å…¨çš„æ•°æ®åº“ä»£ç ã€‚

## ğŸš¨ å…³é”®å®‰å…¨åŸåˆ™

### 1. é¿å…åµŒå¥—çš„ WithConn è°ƒç”¨ - é˜²æ­¢æ­»é”

**âŒ é”™è¯¯ç¤ºä¾‹ - ä¼šå¯¼è‡´æ­»é”ï¼š**

```go
// å±é™©ï¼åµŒå¥—çš„ WithConn è°ƒç”¨ä¼šå¯¼è‡´æ­»é”
err := pool.WithConn(ctx, func(conn1 DatabaseConn) error {
    // å¤–å±‚è¿æ¥
    rows, err := conn1.Query(ctx, "SELECT id FROM users")
    if err != nil {
        return err
    }
    defer rows.Close()
    
    for rows.Next() {
        var id int
        rows.Scan(&id)
        
        // âŒ åµŒå¥—è°ƒç”¨ WithConn - æ­»é”é£é™©ï¼
        err := pool.WithConn(ctx, func(conn2 DatabaseConn) error {
            _, err := conn2.Exec(ctx, "UPDATE users SET last_seen = NOW() WHERE id = ?", id)
            return err
        })
        if err != nil {
            return err
        }
    }
    return nil
})
```

**âœ… æ­£ç¡®ç¤ºä¾‹ - ä½¿ç”¨å•ä¸ªè¿æ¥ï¼š**

```go
// æ­£ç¡®ï¼åœ¨åŒä¸€ä¸ªè¿æ¥ä¸­å®Œæˆæ‰€æœ‰æ“ä½œ
err := pool.WithConn(ctx, func(conn DatabaseConn) error {
    rows, err := conn.Query(ctx, "SELECT id FROM users")
    if err != nil {
        return err
    }
    defer rows.Close()
    
    var ids []int
    for rows.Next() {
        var id int
        rows.Scan(&id)
        ids = append(ids, id)
    }
    
    // åœ¨åŒä¸€ä¸ªè¿æ¥ä¸­æ‰§è¡Œæ›´æ–°
    for _, id := range ids {
        _, err := conn.Exec(ctx, "UPDATE users SET last_seen = NOW() WHERE id = ?", id)
        if err != nil {
            return err
        }
    }
    return nil
})
```

**âœ… æ›´å¥½çš„ç¤ºä¾‹ - ä½¿ç”¨æ‰¹é‡æ“ä½œï¼š**

```go
// æœ€ä½³ï¼ä½¿ç”¨æ‰¹é‡æ›´æ–°é¿å…å¾ªç¯
err := pool.WithConn(ctx, func(conn DatabaseConn) error {
    _, err := conn.Exec(ctx, `
        UPDATE users 
        SET last_seen = NOW() 
        WHERE id IN (SELECT id FROM users WHERE active = 1)
    `)
    return err
})
```

### 2. æ­»é”çš„æ ¹æœ¬åŸå› 

- **è¿æ¥æ± è€—å°½**: åµŒå¥—è°ƒç”¨ä¼šå ç”¨å¤šä¸ªè¿æ¥ï¼Œå½“è¿æ¥æ± æ»¡æ—¶å¯¼è‡´æ­»é”
- **èµ„æºç«äº‰**: å¤–å±‚è¿æ¥ç­‰å¾…å†…å±‚è¿æ¥é‡Šæ”¾ï¼Œå†…å±‚è¿æ¥ç­‰å¾…è¿æ¥æ± å¯ç”¨
- **äº‹åŠ¡å†²çª**: åœ¨äº‹åŠ¡ä¸­åµŒå¥—è°ƒç”¨å¯èƒ½å¯¼è‡´é”ç­‰å¾…

## ğŸ“‹ è¿æ¥ç®¡ç†æœ€ä½³å®è·µ

### 1. åˆç†ä½¿ç”¨ WithConn

```go
// âœ… å¥½çš„å®è·µï¼šçŸ­æ—¶é—´æŒæœ‰è¿æ¥
err := pool.WithConn(ctx, func(conn DatabaseConn) error {
    // å¿«é€Ÿæ‰§è¡Œæ•°æ®åº“æ“ä½œ
    result, err := conn.Exec(ctx, "INSERT INTO users (name) VALUES (?)", name)
    return err
})

// âŒ é¿å…ï¼šé•¿æ—¶é—´æŒæœ‰è¿æ¥
err := pool.WithConn(ctx, func(conn DatabaseConn) error {
    // é¿å…åœ¨è¿æ¥å›è°ƒä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
    time.Sleep(10 * time.Second) // ä¸è¦è¿™æ ·åšï¼
    result, err := conn.Exec(ctx, "INSERT INTO users (name) VALUES (?)", name)
    return err
})
```

### 2. ä¼˜å…ˆä½¿ç”¨äº‹åŠ¡

```go
// âœ… æ¨èï¼šä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
err := pool.WithinTx(ctx, func(tx DatabaseTx) error {
    // åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œå¤šä¸ªç›¸å…³æ“ä½œ
    _, err := tx.Exec(ctx, "INSERT INTO orders (user_id, amount) VALUES (?, ?)", userID, amount)
    if err != nil {
        return err
    }
    
    _, err = tx.Exec(ctx, "UPDATE users SET balance = balance - ? WHERE id = ?", amount, userID)
    return err
})
```

### 3. è¿æ¥æ± é…ç½®

```go
config := Config{
    Pool: PoolConfig{
        MaxOpen:         25,  // æœ€å¤§è¿æ¥æ•°
        MaxIdle:         10,  // æœ€å¤§ç©ºé—²è¿æ¥æ•°
        ConnMaxLifetime: time.Hour,     // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
        ConnMaxIdleTime: 30 * time.Minute, // è¿æ¥æœ€å¤§ç©ºé—²æ—¶é—´
    },
}
```

## ğŸ”„ äº‹åŠ¡å¤„ç†æœ€ä½³å®è·µ

### 1. äº‹åŠ¡è¾¹ç•Œæ§åˆ¶

```go
// âœ… æ­£ç¡®ï¼šæ˜ç¡®çš„äº‹åŠ¡è¾¹ç•Œ
func TransferMoney(pool *Pool, fromID, toID int64, amount decimal.Decimal) error {
    return pool.WithinTx(ctx, func(tx DatabaseTx) error {
        // æ£€æŸ¥ä½™é¢
        var balance decimal.Decimal
        err := tx.QueryRow(ctx, "SELECT balance FROM accounts WHERE id = ?", fromID).Scan(&balance)
        if err != nil {
            return err
        }
        
        if balance.LessThan(amount) {
            return errors.New("insufficient funds")
        }
        
        // æ‰£æ¬¾
        _, err = tx.Exec(ctx, "UPDATE accounts SET balance = balance - ? WHERE id = ?", amount, fromID)
        if err != nil {
            return err
        }
        
        // å…¥è´¦
        _, err = tx.Exec(ctx, "UPDATE accounts SET balance = balance + ? WHERE id = ?", amount, toID)
        return err
    })
}
```

### 2. äº‹åŠ¡é‡è¯•ç­–ç•¥

```go
// âœ… é…ç½®é‡è¯•ç­–ç•¥å¤„ç†æ­»é”
config := Config{
    Retry: RetryPolicy{
        MaxAttempts: 3,
        BaseBackoff: 100 * time.Millisecond,
        MaxBackoff:  time.Second,
        MaxElapsed:  30 * time.Second,
        Jitter:      true,
    },
}
```

## ğŸ“Š æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ

### 1. ä½¿ç”¨é¢„å¤„ç†è¯­å¥ç¼“å­˜

```go
// âœ… å¯ç”¨è¯­å¥ç¼“å­˜æé«˜æ€§èƒ½
err := pool.WithConn(ctx, func(conn DatabaseConn) error {
    conn.EnableStmtCache(100) // ç¼“å­˜100ä¸ªé¢„å¤„ç†è¯­å¥
    
    // é‡å¤æ‰§è¡Œçš„æŸ¥è¯¢ä¼šè¢«ç¼“å­˜
    for _, userID := range userIDs {
        _, err := conn.ExecCached(ctx, "UPDATE users SET last_login = NOW() WHERE id = ?", userID)
        if err != nil {
            return err
        }
    }
    return nil
})
```

### 2. æ‰¹é‡æ“ä½œ

```go
// âœ… ä½¿ç”¨æ‰¹é‡æ’å…¥æé«˜æ€§èƒ½
func BulkInsertUsers(pool *Pool, users []User) error {
    return pool.WithConn(ctx, func(conn DatabaseConn) error {
        columns := []string{"name", "email", "created_at"}
        var rows [][]any
        
        for _, user := range users {
            rows = append(rows, []any{user.Name, user.Email, time.Now()})
        }
        
        _, err := conn.BulkInsert(ctx, "users", columns, rows)
        return err
    })
}
```

### 3. å‘½åå‚æ•°

```go
// âœ… ä½¿ç”¨å‘½åå‚æ•°æé«˜å¯è¯»æ€§
err := pool.WithConn(ctx, func(conn DatabaseConn) error {
    _, err := conn.NamedExec(ctx, `
        INSERT INTO users (name, email, age, city) 
        VALUES (:name, :email, :age, :city)
    `, map[string]any{
        "name":  "å¼ ä¸‰",
        "email": "zhangsan@example.com",
        "age":   30,
        "city":  "åŒ—äº¬",
    })
    return err
})
```

## ğŸ” é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

### 1. é”™è¯¯åˆ†ç±»å¤„ç†

```go
func HandleDatabaseError(err error) error {
    if err == nil {
        return nil
    }
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºå¯é‡è¯•é”™è¯¯
    if IsRetryable(err) {
        log.Warn("Retryable database error", "error", err)
        return err // è®©é‡è¯•æœºåˆ¶å¤„ç†
    }
    
    // æ£€æŸ¥å…·ä½“é”™è¯¯ç±»å‹
    switch Classify(err) {
    case ErrDeadlock:
        return fmt.Errorf("database deadlock detected: %w", err)
    case ErrTimeout:
        return fmt.Errorf("database operation timeout: %w", err)
    case ErrReadOnly:
        return fmt.Errorf("database is read-only: %w", err)
    default:
        return fmt.Errorf("database error: %w", err)
    }
}
```

### 2. ä¸Šä¸‹æ–‡è¶…æ—¶æ§åˆ¶

```go
// âœ… è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
func QueryWithTimeout(pool *Pool, query string) error {
    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()
    
    return pool.WithConn(ctx, func(conn DatabaseConn) error {
        rows, err := conn.Query(ctx, query)
        if err != nil {
            return err
        }
        defer rows.Close()
        
        // å¤„ç†ç»“æœ...
        return nil
    })
}
```

## ğŸ“ˆ ç›‘æ§å’Œè°ƒè¯•æœ€ä½³å®è·µ

### 1. å¯ç”¨æ—¥å¿—è®°å½•

```go
// âœ… å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
pool.EnableLogging(true)
pool.SetSlowQueryThreshold(100 * time.Millisecond)
pool.SetLogger(slog.New(slog.NewJSONHandler(os.Stdout, nil)))
```

### 2. å¯ç”¨æŒ‡æ ‡ç›‘æ§

```go
// âœ… å¯ç”¨æŒ‡æ ‡æ”¶é›†
reader := metric.NewManualReader()
provider := metric.NewMeterProvider(metric.WithReader(reader))

pool.EnableMetrics(true)
pool.SetMeterProvider(provider)
```

### 3. è¿æ¥æ³„æ¼æ£€æµ‹

```go
// âœ… å¯ç”¨è¿æ¥æ³„æ¼æ£€æµ‹
pool.EnableLeakDetection(5 * time.Second, func(leak BorrowLeak) {
    log.Error("Connection leak detected", 
        "duration", leak.Duration,
        "stack", leak.Stack)
})
```

## ğŸ§ª æµ‹è¯•æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ SQLite Mock è¿›è¡Œå•å…ƒæµ‹è¯•

```go
func TestUserService(t *testing.T) {
    ctx := context.Background()
    pool, mock, err := NewMockPool(ctx, Config{})
    require.NoError(t, err)
    defer pool.Close()
    
    // è®¾ç½®æœŸæœ›
    rows := NewRows([]string{"id", "name"})
    rows = AddRow(rows, 1, "å¼ ä¸‰")
    mock.ExpectQuery("SELECT id, name FROM users WHERE active = ?").
        WithArgs(true).
        WillReturnRows(rows)
    
    // æ‰§è¡Œæµ‹è¯•
    service := NewUserService(pool)
    users, err := service.GetActiveUsers(ctx)
    
    // éªŒè¯ç»“æœ
    require.NoError(t, err)
    assert.Len(t, users, 1)
    assert.Equal(t, "å¼ ä¸‰", users[0].Name)
    
    // éªŒè¯æœŸæœ›
    require.NoError(t, mock.ExpectationsWereMet())
}
```

### 2. é›†æˆæµ‹è¯•ä½¿ç”¨çœŸå® SQLite

```go
func TestIntegration(t *testing.T) {
    ctx := context.Background()
    helper, err := NewSQLiteTestHelper(ctx)
    require.NoError(t, err)
    defer helper.Close()
    
    // è®¾ç½®æµ‹è¯•æ•°æ®
    err = helper.SetupUsersTable(ctx)
    require.NoError(t, err)
    
    // æ‰§è¡Œæµ‹è¯•...
}
```

## âš ï¸ å¸¸è§é™·é˜±å’Œé¿å…æ–¹æ³•

### 1. é¿å…åœ¨å¾ªç¯ä¸­åˆ›å»ºè¿æ¥

```go
// âŒ é”™è¯¯ï¼šåœ¨å¾ªç¯ä¸­é‡å¤è·å–è¿æ¥
for _, user := range users {
    pool.WithConn(ctx, func(conn DatabaseConn) error {
        return conn.Exec(ctx, "UPDATE users SET status = ? WHERE id = ?", "active", user.ID)
    })
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å•ä¸ªè¿æ¥æˆ–æ‰¹é‡æ“ä½œ
pool.WithConn(ctx, func(conn DatabaseConn) error {
    for _, user := range users {
        err := conn.Exec(ctx, "UPDATE users SET status = ? WHERE id = ?", "active", user.ID)
        if err != nil {
            return err
        }
    }
    return nil
})
```

### 2. é¿å…å¿˜è®°å…³é—­èµ„æº

```go
// âœ… å§‹ç»ˆä½¿ç”¨ defer å…³é—­èµ„æº
err := pool.WithConn(ctx, func(conn DatabaseConn) error {
    rows, err := conn.Query(ctx, "SELECT * FROM users")
    if err != nil {
        return err
    }
    defer rows.Close() // é‡è¦ï¼šç¡®ä¿å…³é—­
    
    // å¤„ç†ç»“æœ...
    return nil
})
```

### 3. é¿å… SQL æ³¨å…¥

```go
// âŒ å±é™©ï¼šSQL æ³¨å…¥é£é™©
query := fmt.Sprintf("SELECT * FROM users WHERE name = '%s'", userName)

// âœ… å®‰å…¨ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
err := pool.WithConn(ctx, func(conn DatabaseConn) error {
    rows, err := conn.Query(ctx, "SELECT * FROM users WHERE name = ?", userName)
    // ...
})
```

## ğŸ“š æ€»ç»“

éµå¾ªè¿™äº›æœ€ä½³å®è·µå¯ä»¥å¸®åŠ©æ‚¨ï¼š

1. **é¿å…æ­»é”** - ç‰¹åˆ«æ˜¯åµŒå¥— WithConn è°ƒç”¨
2. **æé«˜æ€§èƒ½** - é€šè¿‡è¿æ¥æ± é…ç½®å’Œæ‰¹é‡æ“ä½œ
3. **ç¡®ä¿æ•°æ®ä¸€è‡´æ€§** - æ­£ç¡®ä½¿ç”¨äº‹åŠ¡
4. **ç®€åŒ–è°ƒè¯•** - å¯ç”¨æ—¥å¿—å’Œç›‘æ§
5. **ç¼–å†™å¯é çš„æµ‹è¯•** - ä½¿ç”¨ Mock å’Œé›†æˆæµ‹è¯•

è®°ä½ï¼š**æ°¸è¿œä¸è¦åµŒå¥— WithConn è°ƒç”¨**ï¼Œè¿™æ˜¯é¿å…æ­»é”çš„æœ€é‡è¦åŸåˆ™ï¼
