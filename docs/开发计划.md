## ygggo_mysql 开发计划（v1.0）

- 项目名：ygggo_mysql
- 仓库地址：https://github.com/yggai/ygggo_mysql
- 模块路径：github.com/yggai/ygggo_mysql
- 作者：源滚滚
- 最低 Go 版本：1.22（与 go-sql-driver/mysql 要求保持一致）
- 开发方法：TDD（测试驱动开发），语义化版本（SemVer）

### 1. 目标与范围
- 建设一个基于 MySQL 驱动的通用底层框架，提供：
  1) 连接池与“自动管理连接对象”封装（获取/归还、上下文超时、泄漏检测）；
  2) 高效查询方法（预编译缓存、批量/流式、扫描与绑定、错误分类与幂等重试）；
  3) 事务封装与死锁/只读等可重试机制；
  4) 可观测性（日志、指标、Tracing、慢查询阈值与采样）；
  5) 测试工具（sqlmock、testcontainers、内存型 MySQL 可选）、迁移与夹具基架；
  6) 配置体系、健康检查、优雅退出、（后续）读写分离与治理策略。
- 非目标（本期不含）：全功能 ORM、跨数据库方言抽象、复杂分布式事务。

### 2. 关键选型（见 docs/技术调研.md）
- 驱动/池：go-sql-driver/mysql + database/sql（标准池）
- SQL 便捷层：sqlx（或备选 scany）
- 观测：XSAM/otelsql + sql.DBStats
- 测试：go-sqlmock、testcontainers-go（MySQL 官方镜像）、dolthub/go-mysql-server（可选）
- 迁移：golang-migrate 或 pressly/goose
- 重试：cenkalti/backoff（结合我们自研错误分类）
- Query Builder（可选）：goqu 或 squirrel

### 3. 架构与目录建议
- 包命名（初稿）：
  - internal/mysqlx：核心实现（Config、Pool、Conn、Tx、StmtCache、Retry、Errors、Scan 等）
  - internal/obs：可观测性集成（otelsql、metrics、慢查询采样）
  - internal/testharness：TestHarness（sqlmock、testcontainers、可选 go-mysql-server）
  - internal/fixtures：夹具装载与数据重置
  - cmd/examples：示例（批量、流式、WithinTx 重试、指标导出）
  - docs：需求/调研/计划/进度/变更日志
- 配置：支持 YAML/ENV/代码注入；必要字段 DSN、池参数、重试策略、慢查询阈值、OTel 开关。

### 4. 里程碑与交付（TDD 推进）
- M1（核心最小可用，2 周）
  - 能力：Config、Pool（包装 *sql.DB）、WithConn/Acquire/Close 自动归还、基础 Query/Exec/Get/Select（基于 sqlx）、WithinTx、错误分类雏形、DBStats 指标、慢查询阈值日志
  - 测试：
    - 单元（sqlmock）：连接借用/归还、超时取消、WithinTx 正常/死锁重试、基本扫描
    - 集成（testcontainers）：连接参数、简单 CRUD、DBStats 指标导出
  - 文档/示例：最小示例与使用指南
  - DoD：单测覆盖率≥70%，关键用例 100%，P95 池借用≤2ms（开发机基准）

- M2（效率与稳健，2 周）
  - 能力：StmtCache（LRU）、批量插入/Upsert、QueryStream（行回调/通道）、命名参数工具、错误分级完善（可重试/不可重试/冲突/约束）、统一重试策略（指数退避）
  - 测试：
    - 单元：语句缓存命中、批量/流式边界、错误码分类
    - 集成：并发场景下重试与幂等保障、慢查询采样
  - 观测：OTel Trace（连接借用/SQL 执行）、连接池/SQL 耗时指标完善
  - DoD：预编译命中≥90%（缓存命中用例）、连接复用率≥95%（集成基准）

- M3（测试基架与可选内存型，2 周）
  - 能力：TestHarness（NewTestDB/Reset/Teardown）、夹具加载、sqlmock 与 testcontainers 双路径；可选集成 go-mysql-server（内存）
  - 测试：
    - 单元：夹具加载、Reset 策略（事务/截断）
    - 集成：容器化 MySQL 端到端场景；内存型与真实 MySQL 的差异回归（如启用内存型）
  - DoD：端到端样例稳定运行，24h 压测无连接泄漏

- M4（增强与治理，2 周）
  - 能力：读写分离接口（主/从数据源视图）、限流/熔断/降级（只读路由）、热更新（配置少量项，含池大小平滑过渡）
  - 文档：最佳实践、调优手册、观测看板建议
  - DoD：读写分离功能开关可控、退化路径清晰、满足非功能指标基线

### 4A. 阶段化 TODO 清单（可勾选，按阶段门禁验收）

M0. 项目初始化（~1 周）
- 代码与配置
  - 引入依赖：go-sql-driver/mysql、sqlx、XSAM/otelsql、testify、sqlmock、testcontainers-go、golang-migrate/、cenkalti/backoff
  - [ ] 定义 Config（DSN、pool{maxOpen,maxIdle,life,idle}、retry、telemetry、slowQueryThreshold）


M1. 核心最小可用（~2 周）
- 功能开发
  - [ ] Pool：包装 *sql.DB，Open/Ping/SelfCheck
  - [ ] WithConn(ctx, fn) 与 Acquire(ctx)/Conn.Close()（自动归还、上下文超时）
  - [ ] 泄漏检测雏形（借用超时阈值记录/告警接口预留）
  - [ ] 基础查询：Exec/Query/Get/Select（集成 sqlx，支持扫描/命名参数）
  - [ ] 事务：WithinTx(ctx, fn, opts) + BeginTx；错误分类雏形（死锁/锁超时/只读）
  - [ ] 可观测性：导出 sql.DBStats；慢查询阈值日志（采样）
  - [ ] 示例：cmd/examples/basic_{conn,query,tx}.go
- 测试
  - [ ] 单元（sqlmock）：Pool/WithConn/Acquire/Close/WithinTx/错误分类/扫描
  - [ ] 集成（testcontainers）：连接&自检、简单 CRUD、DBStats 可读取
- 文档
  - [ ] 使用指南（连接、查询、事务、指标）
- 验收标准（Gate）
  - [ ] 覆盖率：全局≥70%，internal/mysqlx 核心≥80%
  - [ ] 集成测试通过（MySQL 8.0；如条件允许，7.x 也通过）
  - [ ] 基准：P95 池借用≤2ms；命令示例：go test ./internal/mysqlx -bench=BenchmarkPoolBorrow -run ^$
  - [ ] DBStats 指标项可获取（Open/Idle/InUse/WaitCount/WaitDuration）

M2. 效率与稳健（~2 周）
- 功能开发
  - [ ] StmtCache（LRU：容量、逐连接策略；命中统计）
  - [ ] 批量：BulkInsert、InsertOnDuplicate（Upsert）
  - [ ] 流式查询：QueryStream(ctx, sql, args...)（回调/通道消费，及时关闭）
  - [ ] 命名参数与绑定工具（辅助构建 IN、结构体切片批量 NamedExec）
  - [ ] 错误分级完善：可重试/不可重试/冲突/约束/只读；
  - [ ] 幂等重试策略：backoff（最大尝试/总时长/抖动）
  - [ ] OTel 集成：otelsql.Wrap/Open，Trace + Metrics 打通
- 测试
  - [ ] 单元：StmtCache 命中/逐出、批量/Upsert 边界、流式超时/取消、错误分类
  - [ ] 并发：WithinTx 可重试稳定性（死锁/只读）、重试上限与幂等保证
  - [ ] 观测：度量项存在性校验（db.sql.connection.*、db.sql.latency 或 db.client.operation.duration）
- 文档
  - [ ] 性能调优与重试策略说明
- 验收标准（Gate）
  - [ ] 预编译命中率≥90%（基于可控用例统计）
  - [ ] 连接复用率≥95%（并发集成用例统计）
  - [ ] Traces 可见，关键 span（连接借用/SQL 执行）存在；指标项齐全
  - [ ] 并发回归与稳定性测试通过（无 goroutine/FD 泄漏）

M3. 测试基架与内存型（可选）（~2 周）
- 功能开发
  - [ ] TestHarness：NewTestDB()/Reset()/Teardown()（独立 DB、迁移、夹具）
  - [ ] 夹具加载器（YAML/CSV/SQL；事务/截断策略）
  - [ ] 双路径：sqlmock 单测、testcontainers 集成
  - [ ] 可选：dolthub/go-mysql-server 内存型接入（文档标注差异与限制）
  - [ ] e2e 示例：端到端用例（含并发、事务、批量、流式）
- 测试
  - [ ] 单元：夹具加载与重置策略、Harness 生命周期
  - [ ] 集成：容器化 MySQL 端到端覆盖；如启用内存型，差异用例通过
- 文档
  - [ ] 测试指引与示例（如何选择 sqlmock vs 容器 vs 内存型）
- 验收标准（Gate）
  - [ ] 端到端示例在 CI 中稳定通过（可按需标记为 nightly）
  - [ ] 1 小时并发稳定性跑批无连接泄漏（本地/CI 夜跑）
  - [ ] 若启用内存型：差异清单已记录并有替代方案或限制声明

M4. 增强与治理（~2 周）
- 功能开发
  - [ ] 读写分离接口：主/从数据源视图；（后续）一致性等级与路由策略预留
  - [ ] 限流/熔断/降级：只读强制到从库、快速失败策略
  - [ ] 热更新：少量配置热更（池大小、阈值），带平滑过渡
  - [ ] 最佳实践文档与调优手册
- 测试
  - [ ] 读写分离回归：主挂/从只读/切换回退
  - [ ] 限流/熔断策略触发与恢复
  - [ ] 热更新过程的稳定性（无抖动/泄漏）
- 验收标准（Gate）
  - [ ] 读写分离开关/路由策略可控，退化路径明确
  - [ ] 压测场景下触发/恢复符合预期（有观测佐证）
  - [ ] 非功能指标达标或有偏差说明与后续项


### 5. TDD 流程规范
- 原则：Red-Green-Refactor；以测试用例定义行为，严禁无测试合并核心功能。
- 测试金字塔：
  - 单元优先（sqlmock/table-driven），保证确定性与速度；
  - 集成测试覆盖关键交互与时序（testcontainers）；
  - 可选端到端示例作为回归样本。
- 常用指令：
  - go test ./... -race -coverprofile=coverage.out
  - go tool cover -func=coverage.out
- 覆盖率门槛：
  - 全局≥70%，关键路径≥90%（Pool/Conn/Tx/Retry/StmtCache）。
- 基准测试：
  - 基础：池借用/归还耗时、简单查询往返时间、StmtCache 命中与内存占用；
  - 并发：WithinTx 重试性能与抖动；
  - 指令：go test -bench=. -benchmem ./...
- 断言与工具：
  - testify/require（或原生 testing+cmp）+ sqlmock；
  - 容器测试要求可并行（随机端口、独立数据库名）。

### 6. 质量与编码规范
- 代码风格：go fmt/go vet；建议集成 golangci-lint（不作为阻塞项时可 warn）
- 错误处理：
  - 统一错误类型与分类（可重试/不可重试/冲突/约束/只读）；
  - wrap 上下文（%w），避免丢失根因；
- API 稳定性：语义化版本管理；公共 API 变更需 RFC/迁移指南。
- 安全：
  - 严禁字符串拼接参数，统一占位符绑定；
  - 敏感日志脱敏；TLS/CA 支持；
- 文档：
  - 每个公开类型/函数需有注释；
  - docs/ 下维护设计、调研、计划、变更日志（CHANGELOG）。

### 7. 观测与运行规范
- 指标：
  - 连接池：MaxOpen、Open（Idle/InUse）、WaitCount、WaitDuration；
  - SQL：执行耗时直方图（区分 Exec/Query/Tx）、慢查询计数/采样；
- Trace：
  - 连接获取与 SQL 执行打 span（otelsql）；
  - 可配置 SQL 文本记录（遵守脱敏策略）；
- 日志：
  - 结构化日志（建议 slog/zap），记录模板、绑定参数摘要（脱敏）、耗时、影响行数、错误分类；

### 8. 持续集成（CI）
- 平台：GitHub Actions
- 阶段：
  1) lint & build（Go 1.22）；
  2) unit test（-race、覆盖率阈值）；
  3) integration test（testcontainers：条件触发/工作流矩阵）；
  4) 基准（可选，定期夜跑，生成历史趋势）；
- 工件：覆盖率报告、基准结果、二进制示例（可选）。

### 9. 任务拆解（首两周示例）
- Week 1：
  - Config 结构与加载（YAML/ENV）；
  - Pool 封装（Open、Ping、自检）；
  - WithConn/Acquire/Close 自动归还与泄漏检测（阈值告警接口预留）；
  - 基础 Query/Exec（sqlx 集成）与扫描；
  - 单元测试（sqlmock）与最小集成用例（testcontainers）；
- Week 2：
  - WithinTx/BeginTx + 重试策略（backoff）与错误分类基础；
  - DBStats 指标导出，慢查询阈值日志；
  - 示例与文档；
  - 集成基准脚本（池借用/简单查询）；

### 10. 验收标准（里程碑）
- 功能：里程碑范围内用例通过率≥95%，关键路径 100%；
- 性能：
  - P95 池借用≤2ms；
  - 简单查询（不含服务器执行）P95≤5ms（开发机基线，CI 仅校验回归差值）；
- 稳定性：24h 并发压测无连接泄漏、内存/FD 无异常增长；
- 兼容性：MySQL 5.7/8.0 集成用例通过；
- 可观测性：关键指标齐全、慢查询可追踪。

### 11. 风险与应对
- “内存型 MySQL”兼容性差异：默认使用 testcontainers 真实 MySQL；内存型作为可选路径，配套差异用例。
- 读写分离复杂度：首期仅暴露接口与主/从视图，不做强策略；后续迭代。
- 语句缓存与资源泄漏：LRU 带上限与自动清理；压测与泄漏检测；
- MPL-2.0 驱动修改限制：避免直接改驱动源码，通过外部封装实现。

### 12. 发布与版本
- 版本规则：SemVer；
  - v0.x：快速迭代期（可引入破坏性变更并在 CHANGELOG 标注）；
  - v1.0：API 基线稳定后发布；
- 发布物：变更日志、升级指南、示例与文档更新；

